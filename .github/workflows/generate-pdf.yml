name: Generate PDF Books

on:
  schedule:
    # í•œêµ­ì‹œê°„ í† ìš”ì¼ ìƒˆë²½ 2ì‹œ = UTC ê¸ˆìš”ì¼ 17:00
    # - cron: '0 17 * * 5'
    # í•œêµ­ì‹œê°„ ì¼ìš”ì¼ ìƒˆë²½ 2ì‹œ = UTC í† ìš”ì¼ 17:00
    - cron: '0 17 * * 6'
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      book_name:
        description: 'íŠ¹ì • ì±…ë§Œ ìƒì„± (ë¹„ìš°ë©´ ì „ì²´)'
        required: false
        default: ''

env:
  LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}
  LIGHTSAIL_USERNAME: bitnami

jobs:
  generate-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # WeasyPrint ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install system dependencies for WeasyPrint
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libgdk-pixbuf2.0-0 \
            libffi-dev \
            shared-mime-info \
            fonts-noto-cjk

      # Python ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Python dependencies
        run: |
          pip install -r pdf_export/requirements.txt

      # PDF ìƒì„± (ì±… í•˜ë‚˜ì”© ìˆœì°¨ ì²˜ë¦¬)
      - name: Generate PDFs
        run: |
          cd pdf_export

          # íŠ¹ì • ì±…ì´ ì§€ì •ëœ ê²½ìš°
          if [ -n "${{ github.event.inputs.book_name }}" ]; then
            echo "ðŸ“š Generating PDF for: ${{ github.event.inputs.book_name }}"
            python export_pdf.py "${{ github.event.inputs.book_name }}"
          else
            # ì „ì²´ ì±… ëª©ë¡ ê°€ì ¸ì™€ì„œ í•˜ë‚˜ì”© ì²˜ë¦¬
            echo "ðŸ“š Generating PDFs for all books..."

            # _md í´ë”ì—ì„œ ì±… ëª©ë¡ ì¶”ì¶œ
            for book_dir in ../_md/*/; do
              book_name=$(basename "$book_dir")

              # ìˆ¨ê¹€ í´ë” ì œì™¸, chapter í´ë”ê°€ ìžˆëŠ” ê²½ìš°ë§Œ
              if [[ ! "$book_name" =~ ^\. ]] && [ -d "../_md/$book_name/chapter01" ]; then
                echo ""
                echo "=========================================="
                echo "ðŸ“– Processing: $book_name"
                echo "=========================================="

                python export_pdf.py "$book_name" || echo "âš ï¸ Failed: $book_name"

                # API ìš”ì²­ ì œí•œì„ ìœ„í•´ ìž ì‹œ ëŒ€ê¸° (Mermaid API)
                sleep 2
              fi
            done
          fi

          echo ""
          echo "âœ… PDF generation completed!"
          ls -la ../public/pdf/ 2>/dev/null || echo "No PDFs generated"

      # ìƒì„±ëœ PDFë¥¼ ì„œë²„ë¡œ ë°°í¬
      - name: Deploy PDFs to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ env.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          source: 'public/pdf/*'
          strip_components: 2
          target: '/opt/bitnami/apache/htdocs/weniVooks/public/pdf'

      # ë°°í¬ ì™„ë£Œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      - name: Summary
        run: |
          echo "## PDF Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated PDFs:" >> $GITHUB_STEP_SUMMARY
          ls -la public/pdf/*.pdf 2>/dev/null | awk '{print "- " $NF}' >> $GITHUB_STEP_SUMMARY || echo "No PDFs found" >> $GITHUB_STEP_SUMMARY
