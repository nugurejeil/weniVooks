name: Generate PDF Books

on:
  schedule:
    # í•œêµ­ì‹œê°„ ë§¤ë‹¬ 2ì¼ ìƒˆë²½ 2ì‹œ = UTC ë§¤ë‹¬ 1ì¼ 17:00
    - cron: '0 17 1 * *'
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      book_name:
        description: 'íŠ¹ì • ì±…ë§Œ ìƒì„± (ë¹„ìš°ë©´ ë³€ê²½ëœ ì±…ë§Œ)'
        required: false
        default: ''
      force_all:
        description: 'ì „ì²´ ì±… ê°•ì œ ìƒì„±'
        type: boolean
        required: false
        default: false

env:
  LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}
  LIGHTSAIL_USERNAME: bitnami

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed_books: ${{ steps.detect.outputs.changed_books }}
      has_changes: ${{ steps.detect.outputs.has_changes }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (diff ë¹„êµìš©)

      - name: Detect changed books
        id: detect
        run: |
          # ìˆ˜ë™ ì‹¤í–‰ + ì „ì²´ ê°•ì œ ìƒì„±
          if [ "${{ github.event.inputs.force_all }}" == "true" ]; then
            echo "ðŸ”„ Force all: ì „ì²´ ì±… ìƒì„±"
            BOOKS=$(ls -d _md/*/ 2>/dev/null | xargs -n1 basename | grep -v '^\.' | tr '\n' ' ')
            echo "changed_books=$BOOKS" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ìˆ˜ë™ ì‹¤í–‰ + íŠ¹ì • ì±… ì§€ì •
          if [ -n "${{ github.event.inputs.book_name }}" ]; then
            echo "ðŸ“š íŠ¹ì • ì±… ì§€ì •: ${{ github.event.inputs.book_name }}"
            echo "changed_books=${{ github.event.inputs.book_name }}" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ (ë³€ê²½ ê°ì§€)
          echo "ðŸ” ë³€ê²½ëœ ì±… ê°ì§€ ì¤‘..."

          # ë§ˆì§€ë§‰ ì„±ê³µí•œ ì›Œí¬í”Œë¡œìš° ì´í›„ ë³€ê²½ ê°ì§€ (ì—†ìœ¼ë©´ ìµœê·¼ 7ì¼)
          SINCE_DATE=$(date -d '7 days ago' '+%Y-%m-%d')

          # _md í´ë”ì—ì„œ ë³€ê²½ëœ íŒŒì¼ ê°ì§€
          CHANGED_FILES=$(git diff --name-only HEAD~50 HEAD -- '_md/' 2>/dev/null || git diff --name-only HEAD -- '_md/')

          if [ -z "$CHANGED_FILES" ]; then
            echo "ë³€ê²½ëœ íŒŒì¼ ì—†ìŒ"
            echo "changed_books=" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ë³€ê²½ëœ ì±… ì´ë¦„ ì¶”ì¶œ (ì¤‘ë³µ ì œê±°)
          CHANGED_BOOKS=$(echo "$CHANGED_FILES" | grep '^_md/' | cut -d'/' -f2 | sort -u | tr '\n' ' ')

          echo "ë³€ê²½ëœ ì±…: $CHANGED_BOOKS"
          echo "changed_books=$CHANGED_BOOKS" >> $GITHUB_OUTPUT

          if [ -n "$CHANGED_BOOKS" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

  generate-pdf:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Python ì˜ì¡´ì„± ìºì‹±
      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pdf_export/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # WeasyPrint ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install system dependencies for WeasyPrint
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libgdk-pixbuf2.0-0 \
            libffi-dev \
            shared-mime-info \
            fonts-noto-cjk

      # Python ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Python dependencies
        run: |
          pip install -r pdf_export/requirements.txt

      # ì„œë²„ì—ì„œ ê¸°ì¡´ PDF ë‹¤ìš´ë¡œë“œ (ì¦ë¶„ ì—…ë°ì´íŠ¸ìš©)
      - name: Download existing PDFs from server
        continue-on-error: true
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ env.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            mkdir -p /opt/bitnami/apache/htdocs/weniVooks/public/pdf

      # PDF ìƒì„± (ë³€ê²½ëœ ì±…ë§Œ)
      - name: Generate PDFs for changed books
        run: |
          cd pdf_export
          mkdir -p ../public/pdf

          CHANGED_BOOKS="${{ needs.detect-changes.outputs.changed_books }}"

          echo "ðŸ“š ìƒì„±í•  ì±… ëª©ë¡: $CHANGED_BOOKS"
          echo ""

          for book_name in $CHANGED_BOOKS; do
            # ì±… í´ë” ì¡´ìž¬ í™•ì¸
            if [ ! -d "../_md/$book_name" ]; then
              echo "âš ï¸ ìŠ¤í‚µ: $book_name (í´ë” ì—†ìŒ)"
              continue
            fi

            # chapter í´ë” ì¡´ìž¬ í™•ì¸
            if [ ! -d "../_md/$book_name/chapter01" ]; then
              echo "âš ï¸ ìŠ¤í‚µ: $book_name (chapter í´ë” ì—†ìŒ)"
              continue
            fi

            echo ""
            echo "=========================================="
            echo "ðŸ“– Processing: $book_name"
            echo "=========================================="

            python export_pdf.py "$book_name" || echo "âš ï¸ Failed: $book_name"

            # Mermaid API ë¶€í•˜ ë°©ì§€
            sleep 1
          done

          echo ""
          echo "âœ… PDF ìƒì„± ì™„ë£Œ!"
          ls -la ../public/pdf/ 2>/dev/null || echo "No PDFs generated"

      # ìƒì„±ëœ PDFê°€ ìžˆëŠ”ì§€ í™•ì¸
      - name: Check generated PDFs
        id: check_pdfs
        run: |
          if [ -d "public/pdf" ] && [ "$(ls -A public/pdf/*.pdf 2>/dev/null)" ]; then
            echo "has_pdfs=true" >> $GITHUB_OUTPUT
            echo "ðŸ“„ ìƒì„±ëœ PDF íŒŒì¼:"
            ls -la public/pdf/*.pdf
          else
            echo "has_pdfs=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ ìƒì„±ëœ PDF ì—†ìŒ"
          fi

      # ìƒì„±ëœ PDFë¥¼ ì„œë²„ë¡œ ë°°í¬
      - name: Deploy PDFs to server
        if: steps.check_pdfs.outputs.has_pdfs == 'true'
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ env.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          source: 'public/pdf/*'
          strip_components: 2
          target: '/opt/bitnami/apache/htdocs/weniVooks/public/pdf'

      # ìš”ì•½
      - name: Summary
        run: |
          echo "## PDF Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ë³€ê²½ ê°ì§€ëœ ì±…" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ needs.detect-changes.outputs.changed_books }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ìƒì„±ëœ PDF" >> $GITHUB_STEP_SUMMARY
          if [ -d "public/pdf" ]; then
            ls public/pdf/*.pdf 2>/dev/null | xargs -n1 basename | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
          else
            echo "ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
          fi
